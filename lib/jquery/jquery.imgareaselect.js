(function(a){function x(){return a("<div/>")}var y=Math.abs,l=Math.max,m=Math.min,n=Math.round;a.imgAreaSelect=function(i,d){function L(b){return b+A.left-u.left}function M(b){return b+A.top-u.top}function F(b){return b-A.left+u.left}function G(b){return b-A.top+u.top}function B(b){var a=b||$,b=b||aa;return{x1:n(c.x1*a),y1:n(c.y1*b),x2:n(c.x2*a),y2:n(c.y2*b),width:n(c.x2*a)-n(c.x1*a),height:n(c.y2*b)-n(c.y1*b)}}function ba(b,a,d,f,e){var g=e||$,e=e||aa;c={x1:n(b/g||0),y1:n(a/e||0),x2:n(d/g||0),y2:n(f/
e||0)};c.width=c.x2-c.x1;c.height=c.y2-c.y1}function H(){v.width()&&(A={left:n(v.offset().left),top:n(v.offset().top)},w=v.innerWidth(),s=v.innerHeight(),A.top+=v.outerHeight()-s>>1,A.left+=v.outerWidth()-w>>1,Q=d.minWidth||0,R=d.minHeight||0,ca=m(d.maxWidth||16777216,w),da=m(d.maxHeight||16777216,s),a().jquery=="1.3.2"&&U=="fixed"&&!ea.getBoundingClientRect&&(A.top+=l(document.body.scrollTop,ea.scrollTop),A.left+=l(document.body.scrollLeft,ea.scrollLeft)),u=a.inArray(N.css("position"),["absolute",
"relative"])+1?{left:n(N.offset().left)-N.scrollLeft(),top:n(N.offset().top)-N.scrollTop()}:U=="fixed"?{left:a(document).scrollLeft(),top:a(document).scrollTop()}:{left:0,top:0},o=L(0),p=M(0),(c.x2>w||c.y2>s)&&V())}function W(b){if(X){j.css({left:L(c.x1),top:M(c.y1)}).add(O).width(C=c.width).height(I=c.height);O.add(r).add(q).css({left:0,top:0});r.width(l(C-r.outerWidth()+r.innerWidth(),0)).height(l(I-r.outerHeight()+r.innerHeight(),0));a(k[0]).css({left:o,top:p,width:c.x1,height:s});a(k[1]).css({left:o+
c.x1,top:p,width:C,height:c.y1});a(k[2]).css({left:o+c.x2,top:p,width:w-c.x2,height:s});a(k[3]).css({left:o+c.x1,top:p+c.y2,width:C,height:s-c.y2});C-=q.outerWidth();I-=q.outerHeight();switch(q.length){case 8:a(q[4]).css({left:C>>1}),a(q[5]).css({left:C,top:I>>1}),a(q[6]).css({left:C>>1,top:I}),a(q[7]).css({top:I>>1});case 4:q.slice(1,3).css({left:C}),q.slice(2,4).css({top:I})}if(b!==!1&&(a.imgAreaSelect.keyPress!=oa&&a(document).unbind(a.imgAreaSelect.keyPress,a.imgAreaSelect.onKeyPress),d.keys))a(document)[a.imgAreaSelect.keyPress](a.imgAreaSelect.onKeyPress=
oa);a.browser.msie&&r.outerWidth()-r.innerWidth()==2&&(r.css("margin",0),setTimeout(function(){r.css("margin","auto")},0))}}function fa(b){H();W(b);f=L(c.x1);e=M(c.y1);g=L(c.x2);h=M(c.y2)}function ga(b,a){d.fadeSpeed?b.fadeOut(d.fadeSpeed,a):b.hide()}function J(b){var a=F(b.pageX-u.left)-c.x1,b=G(b.pageY-u.top)-c.y1;ha||(H(),ha=!0,j.one("mouseout",function(){ha=!1}));t="";d.resizable&&(b<=d.resizeMargin?t="n":b>=c.height-d.resizeMargin&&(t="s"),a<=d.resizeMargin?t+="w":a>=c.width-d.resizeMargin&&
(t+="e"));j.css("cursor",t?t+"-resize":d.movable?"move":"");Y&&Y.toggle()}function pa(){a("body").css("cursor","");(d.autoHide||c.width*c.height==0)&&ga(j.add(k),function(){a(this).hide()});a(document).unbind("mousemove",ia);j.mousemove(J);d.onSelectEnd(i,B())}function qa(b){if(b.which!=1)return!1;H();t?(a("body").css("cursor",t+"-resize"),f=L(c[/w/.test(t)?"x2":"x1"]),e=M(c[/n/.test(t)?"y2":"y1"]),a(document).mousemove(ia).one("mouseup",pa),j.unbind("mousemove",J)):d.movable?(ja=o+c.x1-(b.pageX-
u.left),ka=p+c.y1-(b.pageY-u.top),j.unbind("mousemove",J),a(document).mousemove(ra).one("mouseup",function(){d.onSelectEnd(i,B());a(document).unbind("mousemove",ra);j.mousemove(J)})):v.mousedown(b);return!1}function S(b){D&&(b?(g=l(o,m(o+w,f+y(h-e)*D*(g>f||-1))),h=n(l(p,m(p+s,e+y(g-f)/D*(h>e||-1)))),g=n(g)):(h=l(p,m(p+s,e+y(g-f)/D*(h>e||-1))),g=n(l(o,m(o+w,f+y(h-e)*D*(g>f||-1)))),h=n(h)))}function V(){f=m(f,o+w);e=m(e,p+s);y(g-f)<Q&&(g=f-Q*(g<f||-1),g<o?f=o+Q:g>o+w&&(f=o+w-Q));y(h-e)<R&&(h=e-R*(h<
e||-1),h<p?e=p+R:h>p+s&&(e=p+s-R));g=l(o,m(g,o+w));h=l(p,m(h,p+s));S(y(g-f)<y(h-e)*D);y(g-f)>ca&&(g=f-ca*(g<f||-1),S());y(h-e)>da&&(h=e-da*(h<e||-1),S(!0));c={x1:F(m(f,g)),x2:F(l(f,g)),y1:G(m(e,h)),y2:G(l(e,h)),width:y(g-f),height:y(h-e)};W();d.onSelectChange(i,B())}function ia(b){g=t==""||/w|e/.test(t)||D?b.pageX-u.left:L(c.x2);h=t==""||/n|s/.test(t)||D?b.pageY-u.top:M(c.y2);V();return!1}function T(b,j){g=(f=b)+c.width;h=(e=j)+c.height;a.extend(c,{x1:F(f),y1:G(e),x2:F(g),y2:G(h)});W();d.onSelectChange(i,
B())}function ra(b){f=l(o,m(ja+(b.pageX-u.left),o+w-c.width));e=l(p,m(ka+(b.pageY-u.top),p+s-c.height));T(f,e);b.preventDefault();return!1}function la(){a(document).unbind("mousemove",la);H();g=f;h=e;V();t="";k.is(":not(:visible)")&&j.add(k).hide().fadeIn(d.fadeSpeed||0);X=!0;a(document).unbind("mouseup",ma).mousemove(ia).one("mouseup",pa);j.unbind("mousemove",J);d.onSelectStart(i,B())}function ma(){a(document).unbind("mousemove",la).unbind("mouseup",ma);ga(j.add(k));ba(F(f),G(e),F(f),G(e));d.onSelectChange(i,
B());d.onSelectEnd(i,B())}function sa(b){if(b.which!=1||k.is(":animated"))return!1;H();ja=f=b.pageX-u.left;ka=e=b.pageY-u.top;a(document).mousemove(la).mouseup(ma);return!1}function ta(){fa(!1)}function ua(){va=!0;na(d=a.extend({classPrefix:"imgareaselect",movable:!0,parent:"body",resizable:!0,resizeMargin:10,onInit:function(){},onSelectStart:function(){},onSelectChange:function(){},onSelectEnd:function(){}},d));j.add(k).css({visibility:""});d.show&&(X=!0,H(),W(),j.add(k).hide().fadeIn(d.fadeSpeed||
0));setTimeout(function(){d.onInit(i,B())},0)}function Z(b,a){for(option in a)d[option]!==void 0&&b.css(a[option],d[option])}function na(b){b.parent&&(N=a(b.parent)).append(j.add(k));a.extend(d,b);H();if(b.handles!=null){q.remove();q=a([]);for(P=b.handles?b.handles=="corners"?4:8:0;P--;)q=q.add(x());q.addClass(d.classPrefix+"-handle").css({position:"absolute",fontSize:0,zIndex:E+1||1});!parseInt(q.css("width"))>=0&&q.width(5).height(5);(z=d.borderWidth)&&q.css({borderWidth:z,borderStyle:"solid"});
Z(q,{borderColor1:"border-color",borderColor2:"background-color",borderOpacity:"opacity"})}$=d.imageWidth/w||1;aa=d.imageHeight/s||1;if(b.x1!=null)ba(b.x1,b.y1,b.x2,b.y2),b.show=!b.hide;if(b.keys)d.keys=a.extend({shift:1,ctrl:"resize"},b.keys);k.addClass(d.classPrefix+"-outer");O.addClass(d.classPrefix+"-selection");for(P=0;P++<4;)a(r[P-1]).addClass(d.classPrefix+"-border"+P);Z(O,{selectionColor:"background-color",selectionOpacity:"opacity"});Z(r,{borderOpacity:"opacity",borderWidth:"border-width"});
Z(k,{outerColor:"background-color",outerOpacity:"opacity"});(z=d.borderColor1)&&a(r[0]).css({borderStyle:"solid",borderColor:z});(z=d.borderColor2)&&a(r[1]).css({borderStyle:"dashed",borderColor:z});j.append(O.add(r).add(Y).add(q));a.browser.msie&&((z=k.css("filter").match(/opacity=([0-9]+)/))&&k.css("opacity",z[1]/100),(z=r.css("filter").match(/opacity=([0-9]+)/))&&r.css("opacity",z[1]/100));b.hide?ga(j.add(k)):b.show&&va&&(X=!0,j.add(k).fadeIn(d.fadeSpeed||0),fa());D=(wa=(d.aspectRatio||"").split(/:/))[0]/
wa[1];v.add(k).unbind("mousedown",sa);if(d.disable||d.enable===!1)j.unbind("mousemove",J).unbind("mousedown",qa),a(window).unbind("resize",ta);else{if(d.enable||d.disable===!1)(d.resizable||d.movable)&&j.mousemove(J).mousedown(qa),a(window).resize(ta);d.persistent||v.add(k).mousedown(sa)}d.enable=d.disable=void 0}var v=a(i),va,j=x(),O=x(),r=x().add(x()).add(x()).add(x()),k=x().add(x()).add(x()).add(x()),q=a([]),Y,o,p,A={left:0,top:0},w,s,N,u={left:0,top:0},E=0,U="absolute",ja,ka,$,aa,t,Q,R,ca,da,
D,X,f,e,g,h,c={x1:0,y1:0,x2:0,y2:0,width:0,height:0},ea=document.documentElement,K,wa,P,z,C,I,ha,oa=function(b){var a=d.keys,c,i=b.keyCode;c=!isNaN(a.alt)&&(b.altKey||b.originalEvent.altKey)?a.alt:!isNaN(a.ctrl)&&b.ctrlKey?a.ctrl:!isNaN(a.shift)&&b.shiftKey?a.shift:!isNaN(a.arrows)?a.arrows:10;if(a.arrows=="resize"||a.shift=="resize"&&b.shiftKey||a.ctrl=="resize"&&b.ctrlKey||a.alt=="resize"&&(b.altKey||b.originalEvent.altKey)){switch(i){case 37:c=-c;case 39:b=l(f,g);f=m(f,g);g=l(b+c,f);S();break;
case 38:c=-c;case 40:b=l(e,h);e=m(e,h);h=l(b+c,e);S(!0);break;default:return}V()}else switch(f=m(f,g),e=m(e,h),i){case 37:T(l(f-c,o),e);break;case 38:T(f,l(e-c,p));break;case 39:T(f+m(c,w-F(g)),e);break;case 40:T(f,e+m(c,s-G(h)));break;default:return}return!1};this.remove=function(){na({disable:!0});j.add(k).remove()};this.getOptions=function(){return d};this.setOptions=na;this.getSelection=B;this.setSelection=ba;this.update=fa;for(K=v;K.length;)E=l(E,!isNaN(K.css("z-index"))?K.css("z-index"):E),
K.css("position")=="fixed"&&(U="fixed"),K=K.parent(":not(body)");E=d.zIndex||E;a.browser.msie&&v.attr("unselectable","on");a.imgAreaSelect.keyPress=a.browser.msie||a.browser.safari?"keydown":"keypress";a.browser.opera&&(Y=x().css({width:"100%",height:"100%",position:"absolute",zIndex:E+2||2}));j.add(k).css({visibility:"hidden",position:U,overflow:"hidden",zIndex:E||"0"});j.css({zIndex:E+2||2});O.add(r).css({position:"absolute",fontSize:0});i.complete||i.readyState=="complete"||!v.is("img")?ua():v.one("load",
ua);if(a.browser.msie&&a.browser.version>=9)i.src=i.src};a.fn.imgAreaSelect=function(i){i=i||{};this.each(function(){if(a(this).data("imgAreaSelect"))i.remove?(a(this).data("imgAreaSelect").remove(),a(this).removeData("imgAreaSelect")):a(this).data("imgAreaSelect").setOptions(i);else if(!i.remove){if(i.enable===void 0&&i.disable===void 0)i.enable=!0;a(this).data("imgAreaSelect",new a.imgAreaSelect(this,i))}});if(i.instance)return a(this).data("imgAreaSelect");return this}})(jQuery);
