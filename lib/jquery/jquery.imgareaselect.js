(function(a){function x(){return a("<div/>")}var y=Math.abs,l=Math.max,m=Math.min,g=Math.round;a.imgAreaSelect=function(w,d){var K,L;function M(b){return b+K-s.left}function N(b){return b+L-s.top}function E(b){return b-K+s.left}function F(b){return b-L+s.top}function A(b){var a=b||R,b=b||S;return{x1:g(c.x1*a),y1:g(c.y1*b),x2:g(c.x2*a),y2:g(c.y2*b),width:g(c.x2*a)-g(c.x1*a),height:g(c.y2*b)-g(c.y1*b)}}function da(b,a,d,f,e){var h=e||R,e=e||S;c={x1:g(b/h||0),y1:g(a/e||0),x2:g(d/h||0),y2:g(f/e||0)};
c.width=c.x2-c.x1;c.height=c.y2-c.y1}function G(){t.width()&&(K=g(t.offset().left),L=g(t.offset().top),u=t.innerWidth(),r=t.innerHeight(),L+=t.outerHeight()-r>>1,K+=t.outerWidth()-u>>1,T=g(d.minWidth/R)||0,U=g(d.minHeight/S)||0,ea=g(m(d.maxWidth/R||16777216,u)),fa=g(m(d.maxHeight/S||16777216,r)),a().jquery=="1.3.2"&&X=="fixed"&&!ga.getBoundingClientRect&&(L+=l(document.body.scrollTop,ga.scrollTop),K+=l(document.body.scrollLeft,ga.scrollLeft)),s=/absolute|relative/.test(O.css("position"))?{left:g(O.offset().left)-
O.scrollLeft(),top:g(O.offset().top)-O.scrollTop()}:X=="fixed"?{left:a(document).scrollLeft(),top:a(document).scrollTop()}:{left:0,top:0},n=M(0),o=N(0),(c.x2>u||c.y2>r)&&Y())}function Z(b){if($){j.css({left:M(c.x1),top:N(c.y1)}).add(P).width(B=c.width).height(H=c.height);P.add(q).add(p).css({left:0,top:0});q.width(l(B-q.outerWidth()+q.innerWidth(),0)).height(l(H-q.outerHeight()+q.innerHeight(),0));a(k[0]).css({left:n,top:o,width:c.x1,height:r});a(k[1]).css({left:n+c.x1,top:o,width:B,height:c.y1});
a(k[2]).css({left:n+c.x2,top:o,width:u-c.x2,height:r});a(k[3]).css({left:n+c.x1,top:o+c.y2,width:B,height:r-c.y2});B-=p.outerWidth();H-=p.outerHeight();switch(p.length){case 8:a(p[4]).css({left:B>>1}),a(p[5]).css({left:B,top:H>>1}),a(p[6]).css({left:B>>1,top:H}),a(p[7]).css({top:H>>1});case 4:p.slice(1,3).css({left:B}),p.slice(2,4).css({top:H})}if(b!==false&&(a.imgAreaSelect.keyPress!=pa&&a(document).unbind(a.imgAreaSelect.keyPress,a.imgAreaSelect.onKeyPress),d.keys))a(document)[a.imgAreaSelect.keyPress](a.imgAreaSelect.onKeyPress=
pa);a.browser.msie&&q.outerWidth()-q.innerWidth()==2&&(q.css("margin",0),setTimeout(function(){q.css("margin","auto")},0))}}function ha(b){G();Z(b);f=M(c.x1);e=N(c.y1);h=M(c.x2);i=N(c.y2)}function ia(b,a){d.fadeSpeed?b.fadeOut(d.fadeSpeed,a):b.hide()}function I(b){var a=E(b.pageX-s.left)-c.x1,b=F(b.pageY-s.top)-c.y1;ja||(G(),ja=true,j.one("mouseout",function(){ja=false}));v="";d.resizable&&(b<=d.resizeMargin?v="n":b>=c.height-d.resizeMargin&&(v="s"),a<=d.resizeMargin?v+="w":a>=c.width-d.resizeMargin&&
(v+="e"));j.css("cursor",v?v+"-resize":d.movable?"move":"");aa&&aa.toggle()}function qa(){a("body").css("cursor","");(d.autoHide||c.width*c.height==0)&&ia(j.add(k),function(){a(this).hide()});a(document).unbind("mousemove",ka);j.mousemove(I);d.onSelectEnd(w,A())}function ra(b){if(b.which!=1)return false;G();v?(a("body").css("cursor",v+"-resize"),f=M(c[/w/.test(v)?"x2":"x1"]),e=N(c[/n/.test(v)?"y2":"y1"]),a(document).mousemove(ka).one("mouseup",qa),j.unbind("mousemove",I)):d.movable?(la=n+c.x1-(b.pageX-
s.left),ma=o+c.y1-(b.pageY-s.top),j.unbind("mousemove",I),a(document).mousemove(sa).one("mouseup",function(){d.onSelectEnd(w,A());a(document).unbind("mousemove",sa);j.mousemove(I)})):t.mousedown(b);return false}function V(b){C&&(b?(h=l(n,m(n+u,f+y(i-e)*C*(h>f||-1))),i=g(l(o,m(o+r,e+y(h-f)/C*(i>e||-1)))),h=g(h)):(i=l(o,m(o+r,e+y(h-f)/C*(i>e||-1))),h=g(l(n,m(n+u,f+y(i-e)*C*(h>f||-1)))),i=g(i)))}function Y(){f=m(f,n+u);e=m(e,o+r);y(h-f)<T&&(h=f-T*(h<f||-1),h<n?f=n+T:h>n+u&&(f=n+u-T));y(i-e)<U&&(i=e-
U*(i<e||-1),i<o?e=o+U:i>o+r&&(e=o+r-U));h=l(n,m(h,n+u));i=l(o,m(i,o+r));V(y(h-f)<y(i-e)*C);y(h-f)>ea&&(h=f-ea*(h<f||-1),V());y(i-e)>fa&&(i=e-fa*(i<e||-1),V(true));c={x1:E(m(f,h)),x2:E(l(f,h)),y1:F(m(e,i)),y2:F(l(e,i)),width:y(h-f),height:y(i-e)};Z();d.onSelectChange(w,A())}function ka(b){h=/w|e|^$/.test(v)||C?b.pageX-s.left:M(c.x2);i=/n|s|^$/.test(v)||C?b.pageY-s.top:N(c.y2);Y();return false}function W(b,g){h=(f=b)+c.width;i=(e=g)+c.height;a.extend(c,{x1:E(f),y1:F(e),x2:E(h),y2:F(i)});Z();d.onSelectChange(w,
A())}function sa(b){f=l(n,m(la+(b.pageX-s.left),n+u-c.width));e=l(o,m(ma+(b.pageY-s.top),o+r-c.height));W(f,e);b.preventDefault();return false}function na(){a(document).unbind("mousemove",na);G();h=f;i=e;Y();v="";k.is(":visible")||j.add(k).hide().fadeIn(d.fadeSpeed||0);$=true;a(document).unbind("mouseup",ba).mousemove(ka).one("mouseup",qa);j.unbind("mousemove",I);d.onSelectStart(w,A())}function ba(){a(document).unbind("mousemove",na).unbind("mouseup",ba);ia(j.add(k));da(E(f),F(e),E(f),F(e));!this instanceof
a.imgAreaSelect&&(d.onSelectChange(w,A()),d.onSelectEnd(w,A()))}function ta(b){if(b.which!=1||k.is(":animated"))return false;G();la=f=b.pageX-s.left;ma=e=b.pageY-s.top;a(document).mousemove(na).mouseup(ba);return false}function ua(){ha(false)}function va(){wa=true;oa(d=a.extend({classPrefix:"imgareaselect",movable:true,parent:"body",resizable:true,resizeMargin:10,onInit:function(){},onSelectStart:function(){},onSelectChange:function(){},onSelectEnd:function(){}},d));j.add(k).css({visibility:""});
d.show&&($=true,G(),Z(),j.add(k).hide().fadeIn(d.fadeSpeed||0));setTimeout(function(){d.onInit(w,A())},0)}function ca(b,a){for(option in a)d[option]!==void 0&&b.css(a[option],d[option])}function oa(b){b.parent&&(O=a(b.parent)).append(j.add(k));a.extend(d,b);G();if(b.handles!=null){p.remove();p=a([]);for(Q=b.handles?b.handles=="corners"?4:8:0;Q--;)p=p.add(x());p.addClass(d.classPrefix+"-handle").css({position:"absolute",fontSize:0,zIndex:D+1||1});!parseInt(p.css("width"))>=0&&p.width(5).height(5);
(z=d.borderWidth)&&p.css({borderWidth:z,borderStyle:"solid"});ca(p,{borderColor1:"border-color",borderColor2:"background-color",borderOpacity:"opacity"})}R=d.imageWidth/u||1;S=d.imageHeight/r||1;if(b.x1!=null)da(b.x1,b.y1,b.x2,b.y2),b.show=!b.hide;if(b.keys)d.keys=a.extend({shift:1,ctrl:"resize"},b.keys);k.addClass(d.classPrefix+"-outer");P.addClass(d.classPrefix+"-selection");for(Q=0;Q++<4;)a(q[Q-1]).addClass(d.classPrefix+"-border"+Q);ca(P,{selectionColor:"background-color",selectionOpacity:"opacity"});
ca(q,{borderOpacity:"opacity",borderWidth:"border-width"});ca(k,{outerColor:"background-color",outerOpacity:"opacity"});(z=d.borderColor1)&&a(q[0]).css({borderStyle:"solid",borderColor:z});(z=d.borderColor2)&&a(q[1]).css({borderStyle:"dashed",borderColor:z});j.append(P.add(q).add(aa).add(p));a.browser.msie&&((z=k.css("filter").match(/opacity=(\d+)/))&&k.css("opacity",z[1]/100),(z=q.css("filter").match(/opacity=(\d+)/))&&q.css("opacity",z[1]/100));b.hide?ia(j.add(k)):b.show&&wa&&($=true,j.add(k).fadeIn(d.fadeSpeed||
0),ha());C=(xa=(d.aspectRatio||"").split(/:/))[0]/xa[1];t.add(k).unbind("mousedown",ta);if(d.disable||d.enable===false)j.unbind("mousemove",I).unbind("mousedown",ra),a(window).unbind("resize",ua);else{if(d.enable||d.disable===false)(d.resizable||d.movable)&&j.mousemove(I).mousedown(ra),a(window).resize(ua);d.persistent||t.add(k).mousedown(ta)}d.enable=d.disable=void 0}var t=a(w),wa,j=x(),P=x(),q=x().add(x()).add(x()).add(x()),k=x().add(x()).add(x()).add(x()),p=a([]),aa,n,o;K=0;L=0;var u,r,O,s={left:0,
top:0},D=0,X="absolute",la,ma,R,S,v,T,U,ea,fa,C,$,f,e,h,i,c={x1:0,y1:0,x2:0,y2:0,width:0,height:0},ga=document.documentElement,J,xa,Q,z,B,H,ja,pa=function(b){var a=d.keys,c,g=b.keyCode;c=!isNaN(a.alt)&&(b.altKey||b.originalEvent.altKey)?a.alt:!isNaN(a.ctrl)&&b.ctrlKey?a.ctrl:!isNaN(a.shift)&&b.shiftKey?a.shift:!isNaN(a.arrows)?a.arrows:10;if(a.arrows=="resize"||a.shift=="resize"&&b.shiftKey||a.ctrl=="resize"&&b.ctrlKey||a.alt=="resize"&&(b.altKey||b.originalEvent.altKey)){switch(g){case 37:c=-c;case 39:b=
l(f,h);f=m(f,h);h=l(b+c,f);V();break;case 38:c=-c;case 40:b=l(e,i);e=m(e,i);i=l(b+c,e);V(true);break;default:return}Y()}else switch(f=m(f,h),e=m(e,i),g){case 37:W(l(f-c,n),e);break;case 38:W(f,l(e-c,o));break;case 39:W(f+m(c,u-E(h)),e);break;case 40:W(f,e+m(c,r-F(i)));break;default:return}return false};this.remove=function(){oa({disable:true});j.add(k).remove()};this.getOptions=function(){return d};this.setOptions=oa;this.getSelection=A;this.setSelection=da;this.cancelSelection=ba;this.update=ha;
for(J=t;J.length;)D=l(D,!isNaN(J.css("z-index"))?J.css("z-index"):D),J.css("position")=="fixed"&&(X="fixed"),J=J.parent(":not(body)");D=d.zIndex||D;a.browser.msie&&t.attr("unselectable","on");a.imgAreaSelect.keyPress=a.browser.msie||a.browser.safari?"keydown":"keypress";a.browser.opera&&(aa=x().css({width:"100%",height:"100%",position:"absolute",zIndex:D+2||2}));j.add(k).css({visibility:"hidden",position:X,overflow:"hidden",zIndex:D||"0"});j.css({zIndex:D+2||2});P.add(q).css({position:"absolute",
fontSize:0});w.complete||w.readyState=="complete"||!t.is("img")?va():t.one("load",va);if(a.browser.msie&&a.browser.version>=7)w.src=w.src};a.fn.imgAreaSelect=function(g){g=g||{};this.each(function(){if(a(this).data("imgAreaSelect"))g.remove?(a(this).data("imgAreaSelect").remove(),a(this).removeData("imgAreaSelect")):a(this).data("imgAreaSelect").setOptions(g);else if(!g.remove){if(g.enable===void 0&&g.disable===void 0)g.enable=true;a(this).data("imgAreaSelect",new a.imgAreaSelect(this,g))}});return g.instance?
a(this).data("imgAreaSelect"):this}})(jQuery);
