(function(b){function z(){return b("<div/>")}var A=Math.abs,m=Math.max,n=Math.min,o=Math.round;b.imgAreaSelect=function(j,d){function N(a){return a+I.left-u.left}function O(a){return a+I.top-u.top}function G(a){return a-I.left+u.left}function H(a){return a-I.top+u.top}function C(a){var i=a||ea;a=a||fa;return{x1:o(c.x1*i),y1:o(c.y1*a),x2:o(c.x2*i),y2:o(c.y2*a),width:o(c.x2*i)-o(c.x1*i),height:o(c.y2*a)-o(c.y1*a)}}function qa(a,i,w,X,S){var ra=S||ea;S=S||fa;c={x1:o(a/ra),y1:o(i/S),x2:o(w/ra),y2:o(X/
S)};c.width=c.x2-c.x1;c.height=c.y2-c.y1}function J(){if(x.width()){I={left:o(x.offset().left),top:o(x.offset().top)};y=x.width();v=x.height();T=d.minWidth||0;U=d.minHeight||0;ga=n(d.maxWidth||16777216,y);ha=n(d.maxHeight||16777216,v);if(b().jquery=="1.3.2"&&Y=="fixed"&&!ia.getBoundingClientRect){I.top+=m(document.body.scrollTop,ia.scrollTop);I.left+=m(document.body.scrollLeft,ia.scrollLeft)}u=b.inArray(P.css("position"),["absolute","relative"])+1?{left:o(P.offset().left)-P.scrollLeft(),top:o(P.offset().top)-
P.scrollTop()}:Y=="fixed"?{left:b(document).scrollLeft(),top:b(document).scrollTop()}:{left:0,top:0};p=N(0);q=O(0);if(c.x2>y||c.y2>v)Z()}}function $(a){if(aa){k.css({left:N(c.x1),top:O(c.y1)}).add(Q).width(D=c.width).height(K=c.height);Q.add(s).add(r).css({left:0,top:0});s.width(m(D-s.outerWidth()+s.innerWidth(),0)).height(m(K-s.outerHeight()+s.innerHeight(),0));b(l[0]).css({left:p,top:q,width:c.x1,height:v});b(l[1]).css({left:p+c.x1,top:q,width:D,height:c.y1});b(l[2]).css({left:p+c.x2,top:q,width:y-
c.x2,height:v});b(l[3]).css({left:p+c.x1,top:q+c.y2,width:D,height:v-c.y2});D-=r.outerWidth();K-=r.outerHeight();switch(r.length){case 8:b(r[4]).css({left:D/2});b(r[5]).css({left:D,top:K/2});b(r[6]).css({left:D/2,top:K});b(r[7]).css({top:K/2});case 4:r.slice(1,3).css({left:D});r.slice(2,4).css({top:K})}if(a!==false){b.imgAreaSelect.keyPress!=sa&&b(document).unbind(b.imgAreaSelect.keyPress,b.imgAreaSelect.onKeyPress);if(d.keys)b(document)[b.imgAreaSelect.keyPress](b.imgAreaSelect.onKeyPress=sa)}if(b.browser.msie&&
s.outerWidth()-s.innerWidth()==2){s.css("margin",0);setTimeout(function(){s.css("margin","auto")},0)}}}function ja(a){J();$(a);e=N(c.x1);f=O(c.y1);g=N(c.x2);h=O(c.y2)}function ka(a,i){d.fadeSpeed?a.fadeOut(d.fadeSpeed,i):a.hide()}function L(a){var i=G(a.pageX-u.left)-c.x1;a=H(a.pageY-u.top)-c.y1;if(!la){J();la=true;k.one("mouseout",function(){la=false})}t="";if(d.resizable){if(a<=ba)t="n";else if(a>=c.height-ba)t="s";if(i<=ba)t+="w";else if(i>=c.width-ba)t+="e"}k.css("cursor",t?t+"-resize":d.movable?
"move":"");ca&&ca.toggle()}function ta(){b("body").css("cursor","");if(d.autoHide||c.width*c.height==0)ka(k.add(l),function(){b(this).hide()});d.onSelectEnd(j,C());b(document).unbind("mousemove",ma);k.mousemove(L)}function ua(a){if(a.which!=1)return false;J();if(t){b("body").css("cursor",t+"-resize");e=N(c[/w/.test(t)?"x2":"x1"]);f=O(c[/n/.test(t)?"y2":"y1"]);b(document).mousemove(ma).one("mouseup",ta);k.unbind("mousemove",L)}else if(d.movable){na=p+c.x1-(a.pageX-u.left);oa=q+c.y1-(a.pageY-u.top);
k.unbind("mousemove",L);b(document).mousemove(va).one("mouseup",function(){d.onSelectEnd(j,C());b(document).unbind("mousemove",va);k.mousemove(L)})}else x.mousedown(a);return false}function V(a){if(E)if(a){g=m(p,n(p+y,e+A(h-f)*E*(g>e||-1)));h=o(m(q,n(q+v,f+A(g-e)/E*(h>f||-1))));g=o(g)}else{h=m(q,n(q+v,f+A(g-e)/E*(h>f||-1)));g=o(m(p,n(p+y,e+A(h-f)*E*(g>e||-1))));h=o(h)}}function Z(){e=n(e,p+y);f=n(f,q+v);if(A(g-e)<T){g=e-T*(g<e||-1);if(g<p)e=p+T;else if(g>p+y)e=p+y-T}if(A(h-f)<U){h=f-U*(h<f||-1);if(h<
q)f=q+U;else if(h>q+v)f=q+v-U}g=m(p,n(g,p+y));h=m(q,n(h,q+v));V(A(g-e)<A(h-f)*E);if(A(g-e)>ga){g=e-ga*(g<e||-1);V()}if(A(h-f)>ha){h=f-ha*(h<f||-1);V(true)}c={x1:G(n(e,g)),x2:G(m(e,g)),y1:H(n(f,h)),y2:H(m(f,h)),width:A(g-e),height:A(h-f)};$();d.onSelectChange(j,C())}function ma(a){g=t==""||/w|e/.test(t)||E?a.pageX-u.left:N(c.x2);h=t==""||/n|s/.test(t)||E?a.pageY-u.top:O(c.y2);Z();return false}function W(a,i){g=(e=a)+c.width;h=(f=i)+c.height;b.extend(c,{x1:G(e),y1:H(f),x2:G(g),y2:H(h)});$();d.onSelectChange(j,
C())}function va(a){e=m(p,n(na+(a.pageX-u.left),p+y-c.width));f=m(q,n(oa+(a.pageY-u.top),q+v-c.height));W(e,f);a.preventDefault();return false}function wa(){J();g=e;h=f;Z();t="";if(l.is(":not(:visible)"))k.add(l).hide().fadeIn(d.fadeSpeed||0);aa=true;b(document).unbind("mouseup",xa).mousemove(ma).one("mouseup",ta);k.unbind("mousemove",L);d.onSelectStart(j,C())}function xa(){b(document).unbind("mousemove",wa);ka(k.add(l));c={x1:G(e),y1:H(f),x2:G(e),y2:H(f),width:0,height:0};d.onSelectChange(j,C());
d.onSelectEnd(j,C())}function pa(a){if(a.which!=1||l.is(":animated"))return false;J();na=e=a.pageX-u.left;oa=f=a.pageY-u.top;b(document).one("mousemove",wa).one("mouseup",xa);return false}function ya(){ja(false)}function za(){Aa=true;Ba(d=b.extend({classPrefix:"imgareaselect",movable:true,resizable:true,parent:"body",onInit:function(){},onSelectStart:function(){},onSelectChange:function(){},onSelectEnd:function(){}},d));k.add(l).css({visibility:""});if(d.show){aa=true;J();$();k.add(l).hide().fadeIn(d.fadeSpeed||
0)}setTimeout(function(){d.onInit(j,C())},0)}function da(a,i){for(option in i)d[option]!==undefined&&a.css(i[option],d[option])}function Ba(a){if(a.parent)(P=b(a.parent)).append(k.add(l));b.extend(d,a);J();if(a.handles!=null){r.remove();r=b([]);for(R=a.handles?a.handles=="corners"?4:8:0;R--;)r=r.add(z());r.addClass(d.classPrefix+"-handle").css({position:"absolute",fontSize:0,zIndex:F+1||1});!parseInt(r.css("width"))>=0&&r.width(5).height(5);if(B=d.borderWidth)r.css({borderWidth:B,borderStyle:"solid"});
da(r,{borderColor1:"border-color",borderColor2:"background-color",borderOpacity:"opacity"})}ea=d.imageWidth/y||1;fa=d.imageHeight/v||1;if(a.x1!=null){qa(a.x1,a.y1,a.x2,a.y2);a.show=!a.hide}if(a.keys)d.keys=b.extend({shift:1,ctrl:"resize"},a.keys);l.addClass(d.classPrefix+"-outer");Q.addClass(d.classPrefix+"-selection");for(R=0;R++<4;)b(s[R-1]).addClass(d.classPrefix+"-border"+R);da(Q,{selectionColor:"background-color",selectionOpacity:"opacity"});da(s,{borderOpacity:"opacity",borderWidth:"border-width"});
da(l,{outerColor:"background-color",outerOpacity:"opacity"});if(B=d.borderColor1)b(s[0]).css({borderStyle:"solid",borderColor:B});if(B=d.borderColor2)b(s[1]).css({borderStyle:"dashed",borderColor:B});k.append(Q.add(s).add(r).add(ca));if(b.browser.msie){if(B=l.css("filter").match(/opacity=([0-9]+)/))l.css("opacity",B[1]/100);if(B=s.css("filter").match(/opacity=([0-9]+)/))s.css("opacity",B[1]/100)}if(a.hide)ka(k.add(l));else if(a.show&&Aa){aa=true;k.add(l).fadeIn(d.fadeSpeed||0);ja()}E=(Ca=(d.aspectRatio||
"").split(/:/))[0]/Ca[1];x.add(l).unbind("mousedown",pa);if(d.disable||d.enable===false){k.unbind("mousemove",L).unbind("mousedown",ua);b(window).unbind("resize",ya)}else{if(d.enable||d.disable===false){if(d.resizable||d.movable)k.mousemove(L).mousedown(ua);b(window).resize(ya)}d.persistent||x.add(l).mousedown(pa)}d.enable=d.disable=undefined}var x=b(j),Aa,k=z(),Q=z(),s=z().add(z()).add(z()).add(z()),l=z().add(z()).add(z()).add(z()),r=b([]),ca,p,q,I,y,v,P,u,F=0,Y="absolute",na,oa,ea,fa,ba=10,t,T,
U,ga,ha,E,aa,e,f,g,h,c={x1:0,y1:0,x2:0,y2:0,width:0,height:0},ia=document.documentElement,M,Ca,R,B,D,K,la,sa=function(a){var i=d.keys,w,X=a.keyCode;w=!isNaN(i.alt)&&(a.altKey||a.originalEvent.altKey)?i.alt:!isNaN(i.ctrl)&&a.ctrlKey?i.ctrl:!isNaN(i.shift)&&a.shiftKey?i.shift:!isNaN(i.arrows)?i.arrows:10;if(i.arrows=="resize"||i.shift=="resize"&&a.shiftKey||i.ctrl=="resize"&&a.ctrlKey||i.alt=="resize"&&(a.altKey||a.originalEvent.altKey)){switch(X){case 37:w=-w;case 39:a=m(e,g);e=n(e,g);g=m(a+w,e);V();
break;case 38:w=-w;case 40:a=m(f,h);f=n(f,h);h=m(a+w,f);V(true);break;default:return}Z()}else{e=n(e,g);f=n(f,h);switch(X){case 37:W(m(e-w,p),f);break;case 38:W(e,m(f-w,q));break;case 39:W(e+n(w,y-G(g)),f);break;case 40:W(e,f+n(w,v-H(h)));break;default:return}}return false};this.remove=function(){x.unbind("mousedown",pa);k.add(l).remove()};this.getOptions=function(){return d};this.setOptions=Ba;this.getSelection=C;this.setSelection=qa;this.update=ja;for(M=x;M.length;){F=m(F,!isNaN(M.css("z-index"))?
M.css("z-index"):F);if(M.css("position")=="fixed")Y="fixed";M=M.parent(":not(body)")}F=d.zIndex||F;b.browser.msie&&x.attr("unselectable","on");b.imgAreaSelect.keyPress=b.browser.msie||b.browser.safari?"keydown":"keypress";if(b.browser.opera)ca=z().css({width:"100%",height:"100%",position:"absolute",zIndex:F+2||2});k.add(l).css({visibility:"hidden",position:Y,overflow:"hidden",zIndex:F||"0"});k.css({zIndex:F+2||2});Q.add(s).css({position:"absolute",fontSize:0});j.complete||j.readyState=="complete"||
!x.is("img")?za():x.one("load",za)};b.fn.imgAreaSelect=function(j){j=j||{};this.each(function(){if(b(this).data("imgAreaSelect"))if(j.remove){b(this).data("imgAreaSelect").remove();b(this).removeData("imgAreaSelect")}else b(this).data("imgAreaSelect").setOptions(j);else if(!j.remove){if(j.enable===undefined&&j.disable===undefined)j.enable=true;b(this).data("imgAreaSelect",new b.imgAreaSelect(this,j))}});if(j.instance)return b(this).data("imgAreaSelect");return this}})(jQuery);
