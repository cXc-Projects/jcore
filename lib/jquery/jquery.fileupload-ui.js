(function(c){c.widget("blueimpUI.fileupload",c.blueimp.fileupload,{options:{autoUpload:!1,maxNumberOfFiles:void 0,maxFileSize:void 0,minFileSize:1,acceptFileTypes:/.+$/i,previewFileTypes:/^image\/(gif|jpeg|png)$/,previewMaxWidth:80,previewMaxHeight:80,previewAsCanvas:!0,uploadTemplate:c("#template-upload"),downloadTemplate:c("#template-download"),dataType:"json",add:function(a,b){var d=c(this).data("fileupload");d._adjustMaxNumberOfFiles(-b.files.length);b.isAdjusted=!0;b.isValidated=d._validate(b.files);
b.context=d._renderUpload(b.files).appendTo(c(this).find(".files")).fadeIn(function(){c(this).show()}).data("data",b);if((d.options.autoUpload||b.autoUpload)&&b.isValidated)b.jqXHR=b.submit()},send:function(a,b){if(!b.isValidated){var d=c(this).data("fileupload");b.isAdjusted||d._adjustMaxNumberOfFiles(-b.files.length);if(!d._validate(b.files))return!1}b.context&&b.dataType&&b.dataType.substr(0,6)==="iframe"&&b.context.find(".ui-progressbar").progressbar("value",parseInt(100,10))},done:function(a,
b){var d=c(this).data("fileupload");b.context?b.context.each(function(a){var f=c.isArray(b.result)&&b.result[a]||{error:"emptyResult"};f.error&&d._adjustMaxNumberOfFiles(1);c(this).fadeOut(function(){d._renderDownload([f]).css("display","none").replaceAll(this).fadeIn(function(){c(this).show()})})}):d._renderDownload(b.result).css("display","none").appendTo(c(this).find(".files")).fadeIn(function(){c(this).show()})},fail:function(a,b){var d=c(this).data("fileupload");d._adjustMaxNumberOfFiles(b.files.length);
if(b.context)b.context.each(function(a){c(this).fadeOut(function(){if(b.errorThrown!=="abort"){var f=b.files[a];f.error=f.error||b.errorThrown||!0;d._renderDownload([f]).css("display","none").replaceAll(this).fadeIn(function(){c(this).show()})}else b.context.remove()})});else if(b.errorThrown!=="abort")d._adjustMaxNumberOfFiles(-b.files.length),b.context=d._renderUpload(b.files).css("display","none").appendTo(c(this).find(".files")).fadeIn(function(){c(this).show()}).data("data",b)},progress:function(a,
b){b.context&&b.context.find(".ui-progressbar").progressbar("value",parseInt(b.loaded/b.total*100,10))},progressall:function(a,b){c(this).find(".fileupload-progressbar").progressbar("value",parseInt(b.loaded/b.total*100,10))},start:function(){c(this).find(".fileupload-progressbar").progressbar("value",0).fadeIn()},stop:function(){c(this).find(".fileupload-progressbar").fadeOut()},destroy:function(a,b){var d=c(this).data("fileupload");b.url?c.ajax(b).success(function(){d._adjustMaxNumberOfFiles(1);
c(this).fadeOut(function(){c(this).remove()})}):b.context.fadeOut(function(){c(this).remove()})}},_scaleImage:function(a,b){var b=b||{},c=document.createElement("canvas"),e=Math.min((b.maxWidth||a.width)/a.width,(b.maxHeight||a.height)/a.height);e>=1&&(e=Math.max((b.minWidth||a.width)/a.width,(b.minHeight||a.height)/a.height));a.width=parseInt(a.width*e,10);a.height=parseInt(a.height*e,10);if(!b.canvas||!c.getContext)return a;c.width=a.width;c.height=a.height;c.getContext("2d").drawImage(a,0,0,a.width,
a.height);return c},_createObjectURL:function(a){var b=typeof window.createObjectURL!=="undefined"&&window||typeof URL!=="undefined"&&URL||typeof webkitURL!=="undefined"&&webkitURL;return b?b.createObjectURL(a):!1},_revokeObjectURL:function(a){var b=typeof window.revokeObjectURL!=="undefined"&&window||typeof URL!=="undefined"&&URL||typeof webkitURL!=="undefined"&&webkitURL;return b?b.revokeObjectURL(a):!1},_loadFile:function(a,b){if(typeof FileReader!=="undefined"&&FileReader.prototype.readAsDataURL){var c=
new FileReader;c.onload=function(a){b(a.target.result)};c.readAsDataURL(a);return!0}return!1},_loadImage:function(a,b,d){var e=this,f,g;if(!d||!d.fileTypes||d.fileTypes.test(a.type))f=this._createObjectURL(a),g=c("<img>").bind("load",function(){c(this).unbind("load");e._revokeObjectURL(f);b(e._scaleImage(g[0],d))}).prop("src",f),f||this._loadFile(a,function(a){g.prop("src",a)})},_enableDragToDesktop:function(){var a=c(this),b=a.prop("href"),d=decodeURIComponent(b.split("/").pop()).replace(/:/g,"-");
a.bind("dragstart",function(a){try{a.originalEvent.dataTransfer.setData("DownloadURL",["application/octet-stream",d,b].join(":"))}catch(c){}})},_adjustMaxNumberOfFiles:function(a){typeof this.options.maxNumberOfFiles==="number"&&(this.options.maxNumberOfFiles+=a,this.options.maxNumberOfFiles<1?this._disableFileInputButton():this._enableFileInputButton())},_formatFileSize:function(a){if(typeof a.size!=="number")return"";if(a.size>=1E9)return(a.size/1E9).toFixed(2)+" GB";if(a.size>=1E6)return(a.size/
1E6).toFixed(2)+" MB";return(a.size/1E3).toFixed(2)+" KB"},_hasError:function(a){if(a.error)return a.error;if(this.options.maxNumberOfFiles<0)return"maxNumberOfFiles";if(!this.options.acceptFileTypes.test(a.type)&&!this.options.acceptFileTypes.test(a.name))return"acceptFileTypes";if(this.options.maxFileSize&&a.size>this.options.maxFileSize)return"maxFileSize";if(typeof a.size==="number"&&a.size<this.options.minFileSize)return"minFileSize";return null},_validate:function(a){var b=this,d;c.each(a,function(a,
c){c.error=b._hasError(c);d=!c.error});return d},_uploadTemplateHelper:function(a){a.sizef=this._formatFileSize(a);return a},_renderUploadTemplate:function(a){var b=this;return c.tmpl(this.options.uploadTemplate,c.map(a,function(a){return b._uploadTemplateHelper(a)}))},_renderUpload:function(a){var b=this,d=this.options,e=this._renderUploadTemplate(a);if(!(e instanceof c))return c();e.css("display","none");e.find(".progress div").slice(1).remove().end().first().progressbar();e.find(".start button").slice(this.options.autoUpload?
0:1).remove().end().first().button({text:!1,icons:{primary:"ui-icon-circle-arrow-e"}});e.find(".cancel button").slice(1).remove().end().first().button({text:!1,icons:{primary:"ui-icon-cancel"}});e.find(".preview").each(function(e,g){b._loadImage(a[e],function(a){c(a).hide().appendTo(g).fadeIn()},{maxWidth:d.previewMaxWidth,maxHeight:d.previewMaxHeight,fileTypes:d.previewFileTypes,canvas:d.previewAsCanvas})});return e},_downloadTemplateHelper:function(a){a.sizef=this._formatFileSize(a);return a},_renderDownloadTemplate:function(a){var b=
this;return c.tmpl(this.options.downloadTemplate,c.map(a,function(a){return b._downloadTemplateHelper(a)}))},_renderDownload:function(a){a=this._renderDownloadTemplate(a);if(!(a instanceof c))return c();a.css("display","none");a.find(".delete button").button({text:!1,icons:{primary:"ui-icon-trash"}});a.find("a").each(this._enableDragToDesktop);return a},_startHandler:function(a){a.preventDefault();if((a=c(this).closest(".template-upload").data("data"))&&a.submit&&!a.jqXHR)a.jqXHR=a.submit(),c(this).fadeOut()},
_cancelHandler:function(a){a.preventDefault();var b=c(this).closest(".template-upload").data("data")||{};b.jqXHR?b.jqXHR.abort():(b.errorThrown="abort",a.data.fileupload._trigger("fail",a,b))},_deleteHandler:function(a){a.preventDefault();var b=c(this);a.data.fileupload._trigger("destroy",a,{context:b.closest(".template-download"),url:b.attr("data-url"),type:b.attr("data-type"),dataType:a.data.fileupload.options.dataType})},_initEventHandlers:function(){c.blueimp.fileupload.prototype._initEventHandlers.call(this);
var a=this.element.find(".files"),b={fileupload:this};a.find(".start button").live("click."+this.options.namespace,b,this._startHandler);a.find(".cancel button").live("click."+this.options.namespace,b,this._cancelHandler);a.find(".delete button").live("click."+this.options.namespace,b,this._deleteHandler)},_destroyEventHandlers:function(){var a=this.element.find(".files");a.find(".start button").die("click."+this.options.namespace);a.find(".cancel button").die("click."+this.options.namespace);a.find(".delete button").die("click."+
this.options.namespace);c.blueimp.fileupload.prototype._destroyEventHandlers.call(this)},_initFileUploadButtonBar:function(){var a=this.element.find(".fileupload-buttonbar"),b=this.element.find(".files"),d=this.options.namespace;a.addClass("ui-widget-header ui-corner-top");this.element.find(".fileinput-button").each(function(){var a=c(this).find("input:file").detach();c(this).button({icons:{primary:"ui-icon-plusthick"}}).append(a)});a.find(".start").button({icons:{primary:"ui-icon-circle-arrow-e"}}).bind("click."+
d,function(a){a.preventDefault();b.find(".start button").click()});a.find(".cancel").button({icons:{primary:"ui-icon-cancel"}}).bind("click."+d,function(a){a.preventDefault();b.find(".cancel button").click()});a.find(".delete").button({icons:{primary:"ui-icon-trash"}}).bind("click."+d,function(a){a.preventDefault();b.find(".delete button").click()})},_destroyFileUploadButtonBar:function(){this.element.find(".fileupload-buttonbar").removeClass("ui-widget-header ui-corner-top");this.element.find(".fileinput-button").each(function(){var a=
c(this).find("input:file").detach();c(this).button("destroy").append(a)});this.element.find(".fileupload-buttonbar button").unbind("click."+this.options.namespace).button("destroy")},_enableFileInputButton:function(){this.element.find(".fileinput-button input:file:disabled").each(function(){var a=c(this),b=a.parent();a.detach().prop("disabled",!1);b.button("enable").append(a)})},_disableFileInputButton:function(){this.element.find(".fileinput-button input:file:enabled").each(function(){var a=c(this),
b=a.parent();a.detach().prop("disabled",!0);b.button("disable").append(a)})},_initTemplates:function(){if(this.options.uploadTemplate instanceof c&&!this.options.uploadTemplate.length)this.options.uploadTemplate=c(this.options.uploadTemplate.selector);if(this.options.downloadTemplate instanceof c&&!this.options.downloadTemplate.length)this.options.downloadTemplate=c(this.options.downloadTemplate.selector)},_create:function(){c.blueimp.fileupload.prototype._create.call(this);this._initTemplates();
this.element.addClass("ui-widget");this._initFileUploadButtonBar();this.element.find(".fileupload-content").addClass("ui-widget-content ui-corner-bottom");this.element.find(".fileupload-progressbar").hide().progressbar()},destroy:function(){this.element.find(".fileupload-progressbar").progressbar("destroy");this.element.find(".fileupload-content").removeClass("ui-widget-content ui-corner-bottom");this._destroyFileUploadButtonBar();this.element.removeClass("ui-widget");c.blueimp.fileupload.prototype.destroy.call(this)},
enable:function(){c.blueimp.fileupload.prototype.enable.call(this);this.element.find(":ui-button").not(".fileinput-button").button("enable");this._enableFileInputButton()},disable:function(){this.element.find(":ui-button").not(".fileinput-button").button("disable");this._disableFileInputButton();c.blueimp.fileupload.prototype.disable.call(this)}})})(jQuery);
