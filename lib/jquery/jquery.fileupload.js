(function(d){d.widget("blueimp.fileupload",{options:{namespace:void 0,dropZone:d(document),fileInput:void 0,replaceFileInput:!0,paramName:void 0,singleFileUploads:!0,sequentialUploads:!1,forceIframeTransport:!1,multipart:!0,maxChunkSize:void 0,uploadedBytes:void 0,recalculateProgress:!0,formData:function(a){return a.serializeArray()},add:function(a,b){b.submit()},processData:!1,contentType:!1,cache:!1},_refreshOptionsList:["namespace","dropZone","fileInput"],_isXHRUpload:function(a){return!a.forceIframeTransport&&
typeof XMLHttpRequestUpload!=="undefined"&&typeof File!=="undefined"&&(!a.multipart||typeof FormData!=="undefined")},_getFormData:function(a){var b;if(typeof a.formData==="function")return a.formData(a.form);else if(d.isArray(a.formData))return a.formData;else if(a.formData)return b=[],d.each(a.formData,function(a,e){b.push({name:a,value:e})}),b;return[]},_getTotal:function(a){var b=0;d.each(a,function(a,e){b+=e.size||1});return b},_onProgress:function(a,b){if(a.lengthComputable){var c=b.total||this._getTotal(b.files),
e=parseInt(a.loaded/a.total*(b.chunkSize||c),10)+(b.uploadedBytes||0);this._loaded+=e-(b.loaded||b.uploadedBytes||0);b.lengthComputable=!0;b.loaded=e;b.total=c;this._trigger("progress",a,b);this._trigger("progressall",a,{lengthComputable:!0,loaded:this._loaded,total:this._total})}},_initProgressListener:function(a){var b=this,c=a.xhr?a.xhr():d.ajaxSettings.xhr();if(c.upload&&c.upload.addEventListener)c.upload.addEventListener("progress",function(c){b._onProgress(c,a)},!1),a.xhr=function(){return c}},
_initXHRData:function(a){var b,c=a.files[0];if(!a.multipart||a.blob)if(a.headers=d.extend(a.headers,{"X-File-Name":c.name,"X-File-Type":c.type,"X-File-Size":c.size}),a.blob){if(!a.multipart)a.contentType="application/octet-stream",a.data=a.blob}else a.contentType=c.type,a.data=c;if(a.multipart&&typeof FormData!=="undefined")a.formData instanceof FormData?b=a.formData:(b=new FormData,d.each(this._getFormData(a),function(a,c){b.append(c.name,c.value)})),a.blob?b.append(a.paramName,a.blob):d.each(a.files,
function(c,d){d instanceof Blob&&b.append(a.paramName,d)}),a.data=b;a.blob=null},_initIframeSettings:function(a){a.dataType="iframe "+(a.dataType||"");a.formData=this._getFormData(a)},_initDataSettings:function(a){this._isXHRUpload(a)?this._chunkedUpload(a,!0)||(a.data||this._initXHRData(a),this._initProgressListener(a)):this._initIframeSettings(a)},_initFormSettings:function(a){if(!a.form||!a.form.length)a.form=d(a.fileInput.prop("form"));if(!a.paramName)a.paramName=a.fileInput.prop("name")||"files[]";
if(!a.url)a.url=a.form.prop("action")||location.href;a.type=(a.type||a.form.prop("method")||"").toUpperCase();if(a.type!=="POST"&&a.type!=="PUT")a.type="POST"},_getAJAXSettings:function(a){a=d.extend({},this.options,a);this._initFormSettings(a);this._initDataSettings(a);return a},_enhancePromise:function(a){a.success=a.done;a.error=a.fail;a.complete=a.always;return a},_getXHRPromise:function(a,b,c){var e=d.Deferred(),f=e.promise(),b=b||this.options.context||f;a===!0?e.resolveWith(b,c):a===!1&&e.rejectWith(b,
c);f.abort=e.promise;return this._enhancePromise(f)},_chunkedUpload:function(a,b){var c=this,e=a.files[0],f=e.size,g=a.uploadedBytes=a.uploadedBytes||0,h=a.maxChunkSize||f,i=e.webkitSlice||e.mozSlice||e.slice,j,k;if(!this._isXHRUpload(a)||!i||!(g||h<f)||a.data)return!1;if(b)return!0;if(g>=f)return e.error="uploadedBytes",this._getXHRPromise(!1);f=Math.ceil((f-g)/h);j=function(b){if(!b)return c._getXHRPromise(!0);return j(b-=1).pipe(function(){var f=d.extend({},a);f.blob=i.call(e,g+b*h,g+(b+1)*h);
f.chunkSize=f.blob.size;c._initXHRData(f);c._initProgressListener(f);return k=(d.ajax(f)||c._getXHRPromise(!1,f.context)).done(function(){f.loaded||c._onProgress(d.Event("progress",{lengthComputable:!0,loaded:f.chunkSize,total:f.chunkSize}),f);a.uploadedBytes=f.uploadedBytes+=f.chunkSize})})};f=j(f);f.abort=function(){return k.abort()};return this._enhancePromise(f)},_beforeSend:function(a,b){this._active===0&&this._trigger("start");this._active+=1;this._loaded+=b.uploadedBytes||0;this._total+=this._getTotal(b.files)},
_onDone:function(a,b,c,e){this._isXHRUpload(e)||this._onProgress(d.Event("progress",{lengthComputable:!0,loaded:1,total:1}),e);e.result=a;e.textStatus=b;e.jqXHR=c;this._trigger("done",null,e)},_onFail:function(a,b,c,e){e.jqXHR=a;e.textStatus=b;e.errorThrown=c;this._trigger("fail",null,e);e.recalculateProgress&&(this._loaded-=e.loaded||e.uploadedBytes||0,this._total-=e.total||this._getTotal(e.files))},_onAlways:function(a,b,c,e,d){this._active-=1;d.result=a;d.textStatus=b;d.jqXHR=c;d.errorThrown=e;
this._trigger("always",null,d);if(this._active===0)this._trigger("stop"),this._loaded=this._total=0},_onSend:function(a,b){var c=this,e,f,g=c._getAJAXSettings(b),h=function(b,f){return e=e||(b!==!1&&c._trigger("send",a,g)!==!1&&(c._chunkedUpload(g)||d.ajax(g))||c._getXHRPromise(!1,g.context,f)).done(function(a,b,d){c._onDone(a,b,d,g)}).fail(function(a,b,d){c._onFail(a,b,d,g)}).always(function(a,b,d){!d||typeof d==="string"?c._onAlways(void 0,b,a,d,g):c._onAlways(a,b,d,void 0,g)})};this._beforeSend(a,
g);if(this.options.sequentialUploads)return f=this._sequence=this._sequence.pipe(h,h),f.abort=function(){if(!e)return h(!1,[void 0,"abort","abort"]);return e.abort()},this._enhancePromise(f);return h()},_onAdd:function(a,b){var c=this,e=!0,f=d.extend({},this.options,b);if(f.singleFileUploads&&this._isXHRUpload(f))return d.each(b.files,function(f,h){var i=d.extend({},b,{files:[h]});i.submit=function(){return c._onSend(a,i)};return e=c._trigger("add",a,i)}),e;else if(b.files.length)return b=d.extend({},
b),b.submit=function(){return c._onSend(a,b)},this._trigger("add",a,b)},_normalizeFile:function(a,b){if(b.name===void 0&&b.size===void 0)b.name=b.fileName,b.size=b.fileSize},_replaceFileInput:function(a){var b=a.clone(!0);d("<form></form>").append(b)[0].reset();a.after(b).detach();this.options.fileInput=this.options.fileInput.map(function(c,d){if(d===a[0])return b[0];return d})},_onChange:function(a){var b=a.data.fileupload,c={files:d.each(d.makeArray(a.target.files),b._normalizeFile),fileInput:d(a.target),
form:d(a.target.form)};if(!c.files.length)c.files=[{name:a.target.value.replace(/^.*\\/,"")}];c.form.length?c.fileInput.data("blueimp.fileupload.form",c.form):c.form=c.fileInput.data("blueimp.fileupload.form");b.options.replaceFileInput&&b._replaceFileInput(c.fileInput);if(b._trigger("change",a,c)===!1||b._onAdd(a,c)===!1)return!1},_onDrop:function(a){var b=a.data.fileupload,c=a.dataTransfer=a.originalEvent.dataTransfer,c={files:d.each(d.makeArray(c&&c.files),b._normalizeFile)};if(b._trigger("drop",
a,c)===!1||b._onAdd(a,c)===!1)return!1;a.preventDefault()},_onDragOver:function(a){var b=a.data.fileupload,c=a.dataTransfer=a.originalEvent.dataTransfer;if(b._trigger("dragover",a)===!1)return!1;if(c)c.dropEffect=c.effectAllowed="copy";a.preventDefault()},_initEventHandlers:function(){var a=this.options.namespace||this.name;this.options.dropZone.bind("dragover."+a,{fileupload:this},this._onDragOver).bind("drop."+a,{fileupload:this},this._onDrop);this.options.fileInput.bind("change."+a,{fileupload:this},
this._onChange)},_destroyEventHandlers:function(){var a=this.options.namespace||this.name;this.options.dropZone.unbind("dragover."+a,this._onDragOver).unbind("drop."+a,this._onDrop);this.options.fileInput.unbind("change."+a,this._onChange)},_beforeSetOption:function(){this._destroyEventHandlers()},_afterSetOption:function(){var a=this.options;if(!a.fileInput)a.fileInput=d();if(!a.dropZone)a.dropZone=d();this._initEventHandlers()},_setOption:function(a,b){var c=d.inArray(a,this._refreshOptionsList)!==
-1;c&&this._beforeSetOption(a,b);d.Widget.prototype._setOption.call(this,a,b);c&&this._afterSetOption(a,b)},_create:function(){var a=this.options;if(a.fileInput===void 0)a.fileInput=this.element.is("input:file")?this.element:this.element.find("input:file");else if(!a.fileInput)a.fileInput=d();if(!a.dropZone)a.dropZone=d();this._sequence=this._getXHRPromise(!0);this._active=this._loaded=this._total=0;this._initEventHandlers()},destroy:function(){this._destroyEventHandlers();d.Widget.prototype.destroy.call(this)},
enable:function(){d.Widget.prototype.enable.call(this);this._initEventHandlers()},disable:function(){this._destroyEventHandlers();d.Widget.prototype.disable.call(this)},add:function(a){if(a&&!this.options.disabled)a.files=d.each(d.makeArray(a.files),this._normalizeFile),this._onAdd(null,a)},send:function(a){if(a&&!this.options.disabled&&(a.files=d.each(d.makeArray(a.files),this._normalizeFile),a.files.length))return this._onSend(null,a);return this._getXHRPromise(!1,a&&a.context)}})})(jQuery);
