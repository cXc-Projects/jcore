(function(f){f.widget("blueimp.fileupload",{options:{namespace:void 0,dropZone:f(document),fileInput:void 0,replaceFileInput:true,paramName:void 0,singleFileUploads:true,limitMultiFileUploads:void 0,sequentialUploads:false,limitConcurrentUploads:void 0,forceIframeTransport:false,multipart:true,maxChunkSize:void 0,uploadedBytes:void 0,recalculateProgress:true,formData:function(a){return a.serializeArray()},add:function(a,b){b.submit()},processData:false,contentType:false,cache:false},_refreshOptionsList:["namespace",
"dropZone","fileInput"],_isXHRUpload:function(a){return!a.forceIframeTransport&&typeof XMLHttpRequestUpload!=="undefined"&&typeof File!=="undefined"&&(!a.multipart||typeof FormData!=="undefined")},_getFormData:function(a){var b;if(typeof a.formData==="function")return a.formData(a.form);else if(f.isArray(a.formData))return a.formData;else if(a.formData)return b=[],f.each(a.formData,function(a,e){b.push({name:a,value:e})}),b;return[]},_getTotal:function(a){var b=0;f.each(a,function(a,e){b+=e.size||
1});return b},_onProgress:function(a,b){if(a.lengthComputable){var c=b.total||this._getTotal(b.files),e=parseInt(a.loaded/a.total*(b.chunkSize||c),10)+(b.uploadedBytes||0);this._loaded+=e-(b.loaded||b.uploadedBytes||0);b.lengthComputable=true;b.loaded=e;b.total=c;this._trigger("progress",a,b);this._trigger("progressall",a,{lengthComputable:true,loaded:this._loaded,total:this._total})}},_initProgressListener:function(a){var b=this,c=a.xhr?a.xhr():f.ajaxSettings.xhr();if(c.upload&&c.upload.addEventListener)c.upload.addEventListener("progress",
function(c){b._onProgress(c,a)},false),a.xhr=function(){return c}},_initXHRData:function(a){var b,c=a.files[0];if(!a.multipart||a.blob)if(a.headers=f.extend(a.headers,{"X-File-Name":c.name,"X-File-Type":c.type,"X-File-Size":c.size}),a.blob){if(!a.multipart)a.contentType="application/octet-stream",a.data=a.blob}else a.contentType=c.type,a.data=c;if(a.multipart&&typeof FormData!=="undefined")a.formData instanceof FormData?b=a.formData:(b=new FormData,f.each(this._getFormData(a),function(a,c){b.append(c.name,
c.value)})),a.blob?b.append(a.paramName,a.blob):f.each(a.files,function(c,f){f instanceof Blob&&b.append(a.paramName,f)}),a.data=b;a.blob=null},_initIframeSettings:function(a){a.dataType="iframe "+(a.dataType||"");a.formData=this._getFormData(a)},_initDataSettings:function(a){this._isXHRUpload(a)?this._chunkedUpload(a,true)||(a.data||this._initXHRData(a),this._initProgressListener(a)):this._initIframeSettings(a)},_initFormSettings:function(a){if(!a.form||!a.form.length)a.form=f(a.fileInput.prop("form"));
if(!a.paramName)a.paramName=a.fileInput.prop("name")||"files[]";if(!a.url)a.url=a.form.prop("action")||location.href;a.type=(a.type||a.form.prop("method")||"").toUpperCase();if(a.type!=="POST"&&a.type!=="PUT")a.type="POST"},_getAJAXSettings:function(a){a=f.extend({},this.options,a);this._initFormSettings(a);this._initDataSettings(a);return a},_enhancePromise:function(a){a.success=a.done;a.error=a.fail;a.complete=a.always;return a},_getXHRPromise:function(a,b,c){var e=f.Deferred(),d=e.promise(),b=
b||this.options.context||d;a===true?e.resolveWith(b,c):a===false&&e.rejectWith(b,c);d.abort=e.promise;return this._enhancePromise(d)},_chunkedUpload:function(a,b){var c=this,e=a.files[0],d=e.size,h=a.uploadedBytes=a.uploadedBytes||0,g=a.maxChunkSize||d,i=e.webkitSlice||e.mozSlice||e.slice,j,l;if(!this._isXHRUpload(a)||!i||!(h||g<d)||a.data)return false;if(b)return true;if(h>=d)return e.error="uploadedBytes",this._getXHRPromise(false);d=Math.ceil((d-h)/g);j=function(b){return!b?c._getXHRPromise(true):
j(b-=1).pipe(function(){var d=f.extend({},a);d.blob=i.call(e,h+b*g,h+(b+1)*g);d.chunkSize=d.blob.size;c._initXHRData(d);c._initProgressListener(d);return l=(f.ajax(d)||c._getXHRPromise(false,d.context)).done(function(){d.loaded||c._onProgress(f.Event("progress",{lengthComputable:true,loaded:d.chunkSize,total:d.chunkSize}),d);a.uploadedBytes=d.uploadedBytes+=d.chunkSize})})};d=j(d);d.abort=function(){return l.abort()};return this._enhancePromise(d)},_beforeSend:function(a,b){this._active===0&&this._trigger("start");
this._active+=1;this._loaded+=b.uploadedBytes||0;this._total+=this._getTotal(b.files)},_onDone:function(a,b,c,e){this._isXHRUpload(e)||this._onProgress(f.Event("progress",{lengthComputable:true,loaded:1,total:1}),e);e.result=a;e.textStatus=b;e.jqXHR=c;this._trigger("done",null,e)},_onFail:function(a,b,c,e){e.jqXHR=a;e.textStatus=b;e.errorThrown=c;this._trigger("fail",null,e);e.recalculateProgress&&(this._loaded-=e.loaded||e.uploadedBytes||0,this._total-=e.total||this._getTotal(e.files))},_onAlways:function(a,
b,c,e,d){this._active-=1;d.result=a;d.textStatus=b;d.jqXHR=c;d.errorThrown=e;this._trigger("always",null,d);if(this._active===0)this._trigger("stop"),this._loaded=this._total=0},_onSend:function(a,b){var c=this,e,d,h,g=c._getAJAXSettings(b),i=function(b,d){c._sending+=1;return e=e||(b!==false&&c._trigger("send",a,g)!==false&&(c._chunkedUpload(g)||f.ajax(g))||c._getXHRPromise(false,g.context,d)).done(function(a,b,d){c._onDone(a,b,d,g)}).fail(function(a,b,d){c._onFail(a,b,d,g)}).always(function(a,b,
d){c._sending-=1;d&&d.done?c._onAlways(a,b,d,void 0,g):c._onAlways(void 0,b,a,d,g);if(g.limitConcurrentUploads&&g.limitConcurrentUploads>c._sending)for(a=c._slots.shift();a;){if(!a.isRejected()){a.resolve();break}a=c._slots.shift()}})};this._beforeSend(a,g);return this.options.sequentialUploads||this.options.limitConcurrentUploads&&this.options.limitConcurrentUploads<=this._sending?(this.options.limitConcurrentUploads>1?(d=f.Deferred(),this._slots.push(d),h=d.pipe(i)):h=this._sequence=this._sequence.pipe(i,
i),h.abort=function(){var a=[void 0,"abort","abort"];return!e?(d&&d.rejectWith(a),i(false,a)):e.abort()},this._enhancePromise(h)):i()},_onAdd:function(a,b){var c=this,e=true,d=f.extend({},this.options,b),h=b.files,g=d.limitMultiFileUploads;if(!d.singleFileUploads&&!g||!this._isXHRUpload(d))h=[h];else if(!d.singleFileUploads&&g){h=[];for(d=0;d<b.files.length;d+=g)h.push(b.files.slice(d,d+g))}f.each(h,function(d,g){var h=f.isArray(g)?g:[g],k=f.extend({},b,{files:h});k.submit=function(){return c._onSend(a,
k)};return e=c._trigger("add",a,k)});return e},_normalizeFile:function(a,b){if(b.name===void 0&&b.size===void 0)b.name=b.fileName,b.size=b.fileSize},_replaceFileInput:function(a){var b=a.clone(true);f("<form></form>").append(b)[0].reset();a.after(b).detach();f.cleanData(a.unbind("remove"));this.options.fileInput=this.options.fileInput.map(function(c,e){return e===a[0]?b[0]:e});if(a[0]===this.element[0])this.element=b},_onChange:function(a){var b=a.data.fileupload,c={files:f.each(f.makeArray(a.target.files),
b._normalizeFile),fileInput:f(a.target),form:f(a.target.form)};if(!c.files.length)c.files=[{name:a.target.value.replace(/^.*\\/,"")}];b.options.replaceFileInput&&b._replaceFileInput(c.fileInput);if(b._trigger("change",a,c)===false||b._onAdd(a,c)===false)return false},_onDrop:function(a){var b=a.data.fileupload,c=a.dataTransfer=a.originalEvent.dataTransfer,c={files:f.each(f.makeArray(c&&c.files),b._normalizeFile)};if(b._trigger("drop",a,c)===false||b._onAdd(a,c)===false)return false;a.preventDefault()},
_onDragOver:function(a){var b=a.data.fileupload,c=a.dataTransfer=a.originalEvent.dataTransfer;if(b._trigger("dragover",a)===false)return false;if(c)c.dropEffect=c.effectAllowed="copy";a.preventDefault()},_initEventHandlers:function(){var a=this.options.namespace||this.widgetName;this.options.dropZone.bind("dragover."+a,{fileupload:this},this._onDragOver).bind("drop."+a,{fileupload:this},this._onDrop);this.options.fileInput.bind("change."+a,{fileupload:this},this._onChange)},_destroyEventHandlers:function(){var a=
this.options.namespace||this.widgetName;this.options.dropZone.unbind("dragover."+a,this._onDragOver).unbind("drop."+a,this._onDrop);this.options.fileInput.unbind("change."+a,this._onChange)},_beforeSetOption:function(){this._destroyEventHandlers()},_afterSetOption:function(){var a=this.options;if(!a.fileInput)a.fileInput=f();if(!a.dropZone)a.dropZone=f();this._initEventHandlers()},_setOption:function(a,b){var c=f.inArray(a,this._refreshOptionsList)!==-1;c&&this._beforeSetOption(a,b);f.Widget.prototype._setOption.call(this,
a,b);c&&this._afterSetOption(a,b)},_create:function(){var a=this.options;if(a.fileInput===void 0)a.fileInput=this.element.is("input:file")?this.element:this.element.find("input:file");else if(!a.fileInput)a.fileInput=f();if(!a.dropZone)a.dropZone=f();this._slots=[];this._sequence=this._getXHRPromise(true);this._sending=this._active=this._loaded=this._total=0;this._initEventHandlers()},destroy:function(){this._destroyEventHandlers();f.Widget.prototype.destroy.call(this)},enable:function(){f.Widget.prototype.enable.call(this);
this._initEventHandlers()},disable:function(){this._destroyEventHandlers();f.Widget.prototype.disable.call(this)},add:function(a){if(a&&!this.options.disabled)a.files=f.each(f.makeArray(a.files),this._normalizeFile),this._onAdd(null,a)},send:function(a){return a&&!this.options.disabled&&(a.files=f.each(f.makeArray(a.files),this._normalizeFile),a.files.length)?this._onSend(null,a):this._getXHRPromise(false,a&&a.context)}})})(jQuery);
